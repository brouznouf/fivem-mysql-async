<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Alegreya+Sans:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism.min.css" rel="stylesheet">
    <title>ghmattimysql - Documentation</title>
  </head>
  <body style="margin-top: 56px;">
    <noscript>
      <strong>We're sorry but chargen doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>

    <!-- start navigation -->
    <nav class="navbar navbar-expand-md navbar-dark bg-primary fixed-top">
      <a class="navbar-brand" href="#">ghmattimysql</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="#about">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#setup">Setup</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#config">Configuration</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#execute">Queries</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#transactions">Transactions</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#guidev">GUI & Dev</a>
          </li>
        </ul>
      </div>
    </nav>
    <!-- end navigation -->
    <!-- start main -->
    <main class="container-md pt-3 pb-2 bg-light">
      <h2 id="about">About</h2>
      <p>
        <em>ghmattimysql</em> is a MySQL middleware for FiveM / RedM, that aims for a high accessibility
        and ease of use for developers. It powers the profiling of queries and an ingame interface, that
        helps to analyze which of your resources are creating the largest stress for your MySQL database.
      </p>
      <p>
        Performance is guaranteed by building upon <a href="https://github.com/mysqljs/mysql" target="_blank">mysql.js</a>
        which sports data transfer capabilities beyond that of the FXServer.
      </p>

      <h2 id="setup">Setup</h2>
      <p>
        To Install <em>ghmattimysql</em> your first need to have installed a MySQL Database.
      </p>

      <h4>Database Options</h4>
      <p>
        Included in the table are the benchmark results of 1,000,000 inserts, with 20 done per server tick.
      </p>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Implementation</th>
            <th scope="col">Average Speed</th>
            <th scope="col">[Min, Max]</th>
            <th scope="col">Download Link</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">MariaDB 10.4</th>
            <td>13.94ms &#177; 5.20ms</td>
            <td>[3ms, 151ms]</td>
            <td>
              <a href="https://downloads.mariadb.org/mariadb/10.4" target="_blank" class="btn btn-outline-primary">Download</a>
            </td>
          </tr>
          <tr>
            <th scope="row">MariaDB 10.3</th>
            <td>16.38ms &#177; 7.85ms</td>
            <td>[2ms, 200ms]</td>
            <td>
              <a href="https://downloads.mariadb.org/mariadb/10.3" target="_blank" class="btn btn-outline-primary">Download</a>
            </td>
          </tr>
          <tr>
            <th scope="row">MySQL 5.7</th>
            <td>15.81ms &#177; 5.81ms</td>
            <td>[2ms, 119ms]</td>
            <td>
              <a href="https://dev.mysql.com/downloads/mysql/5.7.html" target="_blank" class="btn btn-outline-primary">Download</a>
            </td>
          </tr>
          <tr>
            <th scope="row">MySQL 8.0</th>
            <td>27.14ms &#177; 66.58ms</td>
            <td>[3ms, 1323ms]</td>
            <td>
              <a href="https://dev.mysql.com/downloads/mysql/" target="_blank" class="btn btn-outline-primary">Download</a>
            </td>
          </tr>
        </tbody>
      </table>

      <h4>Installing the Resource</h4>
      <p>
        After you have installed a database, you will have to add the resource to the server. To do this, first
        <a href="https://github.com/GHMatti/ghmattimysql/releases" target="_blank">download</a> the <code>ghmattimysql.zip</code>
        then extract the contents to the <code>/resources/</code> folder of your server configuration.
      </p>
      <p>
        To learn more about configuring your server follow this <a href="https://docs.fivem.net/docs/server-manual/setting-up-a-server/" target="_blank">Link</a>
        to the FiveM Documentation about the step-by-step guide on setting up FXServer.
      </p>
      <p>
        After the resource has been extracted you will need to add <code>ensure ghmattimysql</code> to your server configuration, and proceed with
        configuring the resource.
      </p>

      <h2 id="config">Configuration</h2>
      <p>
        <em>ghmattimysql</em> can be configured by two different means. The first option would be editing the
        attached <code>config.json</code> for the middleware to connect to the database. The second option
        would be by using the variable <code>mysql_connection_string</code> in your server configuration file. 
        Should you prefer using the variable approach, make sure to delete the <code>config.json</code> in the
        <code>/resources/ghmattimysql/</code> folder.
      </p>
      <p>
        The <code>mysql_connection_string</code> needs to be set in accordance to the options below and it would take the following
        shape in the server configuration file.
        <pre><code>
set mysql_connection_string "mysql://user:password@host/database?debug=true&charset=utf8mb4"
        </code></pre>
        Please make sure the <code>mysql_connection_string</code> is set before the line containing <code>ensure ghmattimysql</code>.
      </p>

      <h4>Configuration Options</h4>
      <p>
        This is taken directly from the <a href="https://github.com/mysqljs/mysql#connection-options" target="_blank">mysql.js Readme file</a>, but trimmed
        to only applicable connection and pooling options.
      </p>
      <div class="list-group">
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">host</h5>
          <p class="mb-1">The hostname of the database you are connecting to. (Default: <code>localhost</code>)</p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">port</h5>
          <p class="mb-1">The port number to connect to. (Default: <code>3306</code>)</p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">localAddress</h5>
          <p class="mb-1">The source IP address to use for TCP connection. (Optional)</p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">socketPath</h5>
          <p class="mb-1">The path to a unix domain socket to connect to. When used <code>host</code> and <code>port</code> are ignored.</p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">user</h5>
          <p class="mb-1">The MySQL user to authenticate as.</p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">password</h5>
          <p class="mb-1">The password of that MySQL user.</p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">database</h5>
          <p class="mb-1">Name of the database to use for this connection (Optional).</p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">charset</h5>
          <p class="mb-1">
            The charset for the connection. This is called "collation" in the SQL-level of MySQL (like <code>utf8_general_ci</code>).
            If a SQL-level charset is specified (like <code>utf8mb4</code>) then the default collation for that charset is used.
            (Default: <code>'UTF8_GENERAL_CI'</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">timezone</h5>
          <p class="mb-1">
            The timezone configured on the MySQL server. This is used to type cast server date/time values to JavaScript Date object
            and vice versa. This can be <code>'local'</code>, <code>'Z'</code>, or an offset in the form <code>+HH:MM</code> or
            <code>-HH:MM.</code> (Default: <code>'local'</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">connectTimeout</h5>
          <p class="mb-1">
            The milliseconds before a timeout occurs during the initial connection to the MySQL server. (Default: <code>10000</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">stringifyObjects</h5>
          <p class="mb-1">
            Stringify objects instead of converting to values. (Default: <code>false</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">insecureAuth</h5>
          <p class="mb-1">
            Allow connecting to MySQL instances that ask for the old (insecure) authentication method. (Default: <code>false</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">supportBigNumbers</h5>
          <p class="mb-1">
            When dealing with big numbers (BIGINT and DECIMAL columns) in the database, you should enable this option (Default: <code>false</code>).
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">bigNumberStrings</h5>
          <p class="mb-1">
            Enabling both <code>supportBigNumbers</code> and <code>bigNumberStrings</code> forces big numbers (BIGINT and DECIMAL columns)
            to be always returned as JavaScript String objects (Default: <code>false</code>).
          </p>
          <p>
            Enabling <code>supportBigNumbers</code> but leaving <code>bigNumberStrings</code> disabled will return big numbers as String objects 
            only when they cannot be accurately represented with
            <a href="http://ecma262-5.com/ELS5_HTML.htm#Section_8.5" target="_blank">JavaScript Number objects</a> (which happens when they exceed
            the [-2<sup>53</sup>, +2<sup>53</sup>] range), otherwise they will be returned as Number objects. This option is ignored if
            <code>supportBigNumbers</code> is disabled.
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">debug</h5>
          <p class="mb-1">
            Prints protocol details to stdout. Can be <code>true</code>/<code>false</code> or an array of packet type names that should be
            printed. (Default: <code>false</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">trace</h5>
          <p class="mb-1">
            Generates stack traces on <code>Error</code> to include call site of library entrance ("long stack traces").
            Slight performance penalty for most calls. (Default: <code>true</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">localInfile</h5>
          <p class="mb-1">
            Allow <code>LOAD DATA INFILE</code> to use the LOCAL modifier. (Default: <code>true</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">multipleStatements</h5>
          <p class="mb-1">
            Allow multiple mysql statements per query. Be careful with this, it could increase the scope of SQL injection attacks. (Default: <code>false</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">flags</h5>
          <p class="mb-1">
            List of connection flags to use other than the default ones. It is also possible to blacklist default ones.
            For more information, check <a href="https://github.com/mysqljs/mysql#connection-flags" target="_blank">Connection Flags</a>.
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">ssl</h5>
          <p class="mb-1">
            object with ssl parameters or a string containing name of ssl profile. See <a href="https://github.com/mysqljs/mysql#ssl-options" target="_blank">SSL options</a>.
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">acquireTimeout</h5>
          <p class="mb-1">
            The milliseconds before a timeout occurs during the connection acquisition. This is slightly different from <code>connectTimeout</code>,
            because acquiring a pool connection does not always involve making a connection. If a connection request is queued,
            the time the request spends in the queue does not count towards this timeout. (Default: <code>10000</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">waitForConnections</h5>
          <p class="mb-1">
            Determines the pool's action when no connections are available and the limit has been reached. If <code>true</code>,
            the pool will queue the connection request and call it when one becomes available. If <code>false</code>, the pool
            will immediately call back with an error. (Default: <code>true</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">connectionLimit</h5>
          <p class="mb-1">
            The maximum number of connections to create at once. (Default: <code>10</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">queueLimit</h5>
          <p class="mb-1">
            The maximum number of connection requests the pool will queue before returning an error from <code>getConnection</code>.
            If set to <code>0</code>, there is no limit to the number of queued connection requests. (Default: <code>0</code>)
          </p>
        </div>
      </div>

      <h4>Additional Configuration Options</h4>
      <p>
        These additional configuration are to be set in the server configuration file, in a similar way to
        setting the <code>mysql_connection_string</code>.
      </p>
      <div class="list-group">
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">mysql_debug</h5>
          <p class="mb-1">Prints out query information to a specified outlet (Default: <code>0</code>)</p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">mysql_debug_output</h5>
          <p class="mb-1">
            Sets the location where to output information from <code>mysql_debug</code>.
            Possible options are <code>console</code>, <code>file</code>, and <code>both</code>.
            In case of a file output, the file will be located in the current working directory
            on starting the server, named like the resource, e.g. <code>/ghmattimysql.log</code>
            (Default: <code>console</code>)
          </p>
        </div>
        <div class="list-group-item flex-column align-items-start">
          <h5 class="mb-1">mysql_slow_query_warning</h5>
          <p class="mb-1">
            Sets a limit in millisecondss, queries slower than this limit will be displayed with a warning at the specified location of
            <code>mysql_debug_output</code>, see above (Default: <code>100</code>)
          </p>
        </div>
      </div>

      <h2 id="execute">Queries</h2>
      <p>
        To run any kind of queries, you can access the exports of the resource, e.g. in JavaScript via <code>exports.ghmattimysql</code>.
        To learn more about accessing exports please refer to your respective scripting runtime in the
        <a href="https://docs.fivem.net/docs/scripting-manual/runtimes/" target="_blank">FiveM Documentation</a>. Hereafter this documentation
        will only refer to the exported function names.
      </p>
      <p>
        The universal function is execute. It will handle almost all of your requests, apart from transactions. The <code>Sync</code>-variants are
        just sync wrappers for the normal async calls and should not impact code performance, but can only be accessed with <code>Lua</code> or
        <code>C#</code>.
        <pre><code class="language-typescript">execute(query: string, parameters?: object | array, callback?: function): void
execute(query: string, callback?: function): void
executeSync(query: string, parameters?: object | array): result</code></pre>
      </p>
      <p>
        Example of selecting a row with the old / C# syntax in <code>Lua</code>. Note that the <code>@</code>
        in the <code>parameters</code> argument is not needed, and you could just go with <code>id</code> as seen in the
        transaction examples.
        <pre><code class="language-lua">local playerId = getPlayerId()
exports.ghmattimysql:execute("SELECT * FROM users WHERE id = @id", { ['@id'] = playerId }, function(result)
    print(json.encode(result))
end)
--[[
prints:

[{
  "id": 95585726093402110,
  "cash": 0,
  "bank": 0,
  "skin": "{}",
  "online": true,
  "lastSeen": 1590656804000
}]
]]--</code></pre>
      </p>
      <p>
        Example of inserting a row with the mysql.js syntax in <code>JavaScript</code>. Note that insertId is only not 0, if
        the insert happens into a table with an autoincremented id.
        <pre><code class="language-js">const { x, y, z } = getPlayerCoordinates(playerId);
exports.ghmattimysql.execute("INSERT INTO users_log (x, y, z, playerId) VALUES (?, ?, ?, ?)",
  [ x, y, z, playerId ], (result) => { 
    console.log(JSON.stringify(result));
  }
);
/*
prints:

{
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "serverStatus": 2,
  "warningCount: 0,
  "message": "",
  "protocol41": true,
  "changedRows": 0
}
*/</code></pre>
      </p>
      <p>
        Example of inserting multiple rows with the mysql.js syntax in <code>JavaScript</code>.
        <pre><code class="language-js">const rows = players.map((player) => {
  const { x, y, z } = getPlayerCoordinates(player.id);
  return [x, y, z, player.id];
});
exports.ghmattimysql.execute("INSERT INTO users_log (x, y, z, playerId) VALUES ?", [rows], (result) => { 
  console.log(JSON.stringify(result));
});
/*
prints:

{
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "serverStatus": 2,
  "warningCount: 0,
  "message": "",
  "protocol41": true,
  "changedRows": 0
}
*/</code></pre>
      </p>
      <p>
        Example of updating a row with the mysql.js syntax.
      <pre><code class="language-lua">local values = { "users", "online", true, "id", getPlayerId() }
exports.ghmattimysql:execute("UPDATE ?? SET ?? = ? WHERE ?? = ?", values,
  function(result)
    print(json.encode(result))
  end
)
--[[
prints:

{
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "serverStatus": 2,
  "warningCount: 0,
  "message": "(Rows matched: 1 Changed: 1 Warnings: 0)",
  "protocol41": true,
  "changedRows": 1
}
]]--</code></pre>
      </p>

      <h4>Scalar</h4>
      <p>
        The scalar export is a cut-down execute for <code>SELECT</code> only, it only returns a singular value, e.g. it will fetch the first
      column of the first row selected.
      <pre><code class="language-typescript">scalar(query: string, parameters?: object | array, callback?: function): void
scalar(query: string, callback?: function): void
scalarSync(query: string, parameters?: object | array): result</code></pre>
      </p>

      <h2 id="transactions">Transactions</h2>
      <p>
        Transactions in <em>ghmattimysql</em> support two different syntaxes. One where the parameters are embedded in the query
        <code>object</code> and one where it is supplied as an argument to the <code>transaction</code> export itself. The query object
        follows this structure <code>[{query: string, values: object | array}]</code>. Similar to the <code>execute</code> export,
        the <code>values</code> field supports, like the <code>parameters</code> argument to the function, either the newer mysql.js
        type of parameters or the old version that the C# connector uses.
      </p>
      <p>
        A transaction will only commit all queries to the database, if all queries to the database succeed. If one of them fails,
        no changes to the database will be made. This can be easily used when e.g. transfering money, making sure that the money
        field is positive. A transaction would fail if someone would attempt to have negative cash, so that no money would be
        transfered.
      </p>
      <p>
        Since the transaction will either fail or succeed, the callback of the function will either answer with <code>true</code>
        or <code>false</code> depending on if the transaction succeeded. If it fails an error message will be printed, but it is
        an intended one, since the commit to the database would be likely unwanted.      
      <pre><code class="language-typescript">transaction(query: string[], parameters?: object | array, callback?: function): void
transaction(query: object[], callback?: function): void
transactionSync(query: string[], parameters?: object | array): result
transactionSync(query: object[]): result</code></pre>
      </p>
      <p>
        While transactions do support seperate <code>parameters</code> as an <code>array</code>, it has very limited use cases,
        as if the parameter is supplied not inside the query <code>object</code>, but as an argument to the function, it will be
        applied to every query <code>string</code>, which could lead to executing the same query accidently twice.
      </p>
      <p>
        Example of a transaction using the <code>parameters</code> field in <code>JavaScript</code>.
        <pre><code class="language-js">exports.ghmattimysql.transaction([
    'UPDATE users SET cash = cash - @transfer WHERE id = @senderId',
    'UPDATE users SET cash = cash + @transfer WHERE id = @recipientId'
  ], { transfer: amount, senderId, recipientId }, (success) => {
    console.log(`${success ? 'Succeeded' : 'Failed'} in transfering $${amount} cash.`)
  }
);</code></pre>
      </p>
      <p>
        Example of the same transaction not using the <code>parameters</code> field in <code>JavaScript</code>.
        This example also supports as values the C# syntax with the <code>@</code> values.
        <pre><code class="language-js">exports.ghmattimysql.transaction([
    { query: 'UPDATE users SET cash = cash - ? WHERE id = ?', values: [amount, senderId] },
    { query: 'UPDATE users SET cash = cash + ? WHERE id = ?', values: [amount, recipientId] },
  ], (success) => {
    console.log(`${success ? 'Succeeded' : 'Failed'} in transfering $${amount} cash.`)
  }
);</code></pre>
      </p>
      <p>
        This syntax is better when you have two distinct set of values, but if half or more of the values are shared,
        the first syntax might be preferable, due to it being more concise then.
      </p>

      <h2 id="guidev">GUI & Dev</h2>
      <p>
        With administration rights on your server, if you are unsure how to get those check the
        <a href="https://docs.fivem.net/docs/server-manual/setting-up-a-server/" target="_blank">step-by-step guide on setting up FXServer</a>,
        you can type in the command <code>mysql</code> into the console to open the GUI. You can open that console via the <kbd>F8</kbd> key.
        It should show you a concise summary of how your server is doing.
      </p>
      <p>
        The first tab shows you a time-resolved graph showing how long the queries took time in a five minute interval.
        As a general rule of thumb the server should not spend more than 300,000ms querying the database. It could become especially problematic
        if the amount of queries is at that point lower than 6,000, at which point your queries are likely too slow and
        are in need of optimization.
      </p>
      <p>
        The second tab shows you the same as the first tab, but instead of the queries being time-resolved they are resolved by the resources
        which trigger them. So you can see which resources ask for the largest amount of database time.
      </p>
      <p>
        The last slow query tab lists the 21 slowest queries. If they are all below the max-limit in <a href="#setup">table for MySQL servers</a>,
        then there is no need to panic, it might be database and not a query related issue.
      </p>
      <figure class="figure">
        <img src="<%=require('./img/gui.webp').default%>" class="figure-img img-fluid rounded" alt="Ingame view of the GUI">
        <figcaption class="figure-caption">View of the GUI ingame.</figcaption>
      </figure>

      <h4>Toggle Debug Print</h4>
      <p>
        Given you have admin rights, you can use the command <code>mysql:debug</code> which flips interally the value
        for <code>mysql_debug</code> to <code>1</code> or <code>0</code>, so it enables you to turn on the debug prints
        to the console or a file, or both given your settings for <code>mysql_debug_output</code>.
      </p>
      
    </main>
    <!-- end main -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.slim.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
  </body>
</html>
